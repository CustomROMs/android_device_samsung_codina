From 57424cc7889edb6dc0e96015d1580a768e3d066a Mon Sep 17 00:00:00 2001
From: Shilin Victor <radicaldreamer00001@gmail.com>
Date: Fri, 29 Mar 2019 22:55:20 +0300
Subject: [PATCH 19/20] system-core_WW008-Draw-battery-charging-animation.patch

Change-Id: Iaa7469dff0be53eb599f2f8b33cb10c1d7be9cd0
---
 healthd/Android.mk               |  4 ++++
 healthd/healthd_mode_charger.cpp | 25 +++++++++++++++++++++++--
 2 files changed, 27 insertions(+), 2 deletions(-)

diff --git a/healthd/Android.mk b/healthd/Android.mk
index f509aceed..32016ae25 100644
--- a/healthd/Android.mk
+++ b/healthd/Android.mk
@@ -56,6 +56,10 @@ ifeq ($(strip $(BOARD_NO_CHARGER_LED)),true)
 LOCAL_CFLAGS += -DNO_CHARGER_LED
 endif
 
+ifeq ($(strip $(BOARD_CHARGER_SHOW_PERCENTAGE)),true)
+LOCAL_CFLAGS += -DCHARGER_SHOW_PERCENTAGE
+endif
+
 LOCAL_C_INCLUDES := bootable/recovery
 
 LOCAL_STATIC_LIBRARIES := libbatteryservice libbinder libminui libpng libz libutils libstdc++ libcutils liblog libm libc
diff --git a/healthd/healthd_mode_charger.cpp b/healthd/healthd_mode_charger.cpp
index 6df9f125e..e365db6dc 100644
--- a/healthd/healthd_mode_charger.cpp
+++ b/healthd/healthd_mode_charger.cpp
@@ -431,6 +431,23 @@ static void draw_battery(struct charger *charger)
     healthd_board_mode_charger_draw_battery(batt_prop);
 }
 
+#ifdef CHARGER_SHOW_PERCENTAGE
+#define STR_LEN    64
+static void draw_capacity(struct charger *charger)
+{
+    char cap_str[STR_LEN];
+    int x, y;
+    int str_len_px;
+
+    snprintf(cap_str, (STR_LEN - 1), "%d%%", charger->batt_anim->capacity);
+    str_len_px = gr_measure(cap_str);
+    x = (gr_fb_width() - str_len_px) / 2;
+    y = (gr_fb_height() + char_height) / 2;
+    android_green();
+    gr_text(x, y, cap_str, 0);
+}
+#endif
+
 static void redraw_screen(struct charger *charger)
 {
     struct animation *batt_anim = charger->batt_anim;
@@ -438,10 +455,14 @@ static void redraw_screen(struct charger *charger)
     clear_screen();
 
     /* try to display *something* */
-    if (batt_anim->capacity < 0 || batt_anim->num_frames == 0)
+    if (batt_anim->capacity < 0 || batt_anim->num_frames == 0) {
         draw_unknown(charger);
-    else
+    } else {
         draw_battery(charger);
+#ifdef CHARGER_SHOW_PERCENTAGE
+        draw_capacity(charger);
+#endif
+    }
     gr_flip();
 }
 
-- 
2.11.0

