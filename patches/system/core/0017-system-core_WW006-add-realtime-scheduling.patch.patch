From 78c4ca27edc32fe4102674d3611939c19d4f5060 Mon Sep 17 00:00:00 2001
From: Shilin Victor <radicaldreamer00001@gmail.com>
Date: Fri, 29 Mar 2019 22:55:20 +0300
Subject: [PATCH 17/20] system-core_WW006-add-realtime-scheduling.patch

Change-Id: Ice154d46cedd0518f073116c96639325c12211d1
---
 include/system/thread_defs.h |  6 ++++++
 include/utils/ThreadDefs.h   |  1 +
 libutils/Threads.cpp         | 12 ++++++++++++
 3 files changed, 19 insertions(+)

diff --git a/include/system/thread_defs.h b/include/system/thread_defs.h
index 377a48ce9..65f6dd278 100644
--- a/include/system/thread_defs.h
+++ b/include/system/thread_defs.h
@@ -65,6 +65,12 @@ enum {
      * be allowed to use this level */
     ANDROID_PRIORITY_HIGHEST        = -20,
 
+    // BEGIN Motorola, IKJBXLINE-9555, rknize2, 05/10/2013
+    /* Because of the way Android munges the policy with the priority, handle
+     * RT as a special case. Actual RT priority is set using a different API */
+    ANDROID_PRIORITY_REALTIME       = -21,
+    // END Motorola, IKJBXLINE-9555
+
     ANDROID_PRIORITY_DEFAULT        = ANDROID_PRIORITY_NORMAL,
     ANDROID_PRIORITY_MORE_FAVORABLE = -1,
     ANDROID_PRIORITY_LESS_FAVORABLE = +1,
diff --git a/include/utils/ThreadDefs.h b/include/utils/ThreadDefs.h
index 9711c1379..67e8768bc 100644
--- a/include/utils/ThreadDefs.h
+++ b/include/utils/ThreadDefs.h
@@ -56,6 +56,7 @@ enum {
     PRIORITY_AUDIO          = ANDROID_PRIORITY_AUDIO,
     PRIORITY_URGENT_AUDIO   = ANDROID_PRIORITY_URGENT_AUDIO,
     PRIORITY_HIGHEST        = ANDROID_PRIORITY_HIGHEST,
+    PRIORITY_REALTIME       = ANDROID_PRIORITY_REALTIME, // Motorola, IKJBXLINE-9555, rknize2, 05/10/2013
     PRIORITY_DEFAULT        = ANDROID_PRIORITY_DEFAULT,
     PRIORITY_MORE_FAVORABLE = ANDROID_PRIORITY_MORE_FAVORABLE,
     PRIORITY_LESS_FAVORABLE = ANDROID_PRIORITY_LESS_FAVORABLE,
diff --git a/libutils/Threads.cpp b/libutils/Threads.cpp
index 1e014c64e..82cf9eb82 100644
--- a/libutils/Threads.cpp
+++ b/libutils/Threads.cpp
@@ -85,6 +85,13 @@ struct thread_data_t {
         char * name = t->threadName;
         delete t;
         setpriority(PRIO_PROCESS, 0, prio);
+// BEGIN Motorola, IKJBXLINE-9555, rknize2, 05/10/2013
+#if defined(__ANDROID__)
+        if (prio == ANDROID_PRIORITY_REALTIME) {
+            set_sched_policy(gettid(), SP_REALTIME);
+        } else
+#endif
+// END Motorola, IKJBXLINE-9555
         if (prio >= ANDROID_PRIORITY_BACKGROUND) {
             set_sched_policy(0, SP_BACKGROUND);
         } else {
@@ -309,6 +316,11 @@ int androidSetThreadPriority(pid_t tid, int pri)
 #if !defined(_WIN32)
     int lasterr = 0;
 
+// BEGIN Motorola, IKJBXLINE-9555, w04904, 05/10/2013
+    if (pri == ANDROID_PRIORITY_REALTIME) {
+        rc = set_sched_policy(tid, SP_REALTIME);
+    } else
+// END Motorola, IKJBXLINE-9555
     if (pri >= ANDROID_PRIORITY_BACKGROUND) {
         rc = set_sched_policy(tid, SP_BACKGROUND);
     } else if (getpriority(PRIO_PROCESS, tid) >= ANDROID_PRIORITY_BACKGROUND) {
-- 
2.11.0

