From 87d0a520a632d9dcaf45954ba9c2c02733bfded8 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH 27/31] init: fix reboot to recovery / bootloader

Change-Id: I2c6297b388d9798a8bdfffea6241342b911e6658
---
 init/reboot.cpp | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/init/reboot.cpp b/init/reboot.cpp
index 328164f78..290445531 100644
--- a/init/reboot.cpp
+++ b/init/reboot.cpp
@@ -79,6 +79,10 @@ enum UmountStat {
     UMOUNT_STAT_NOT_AVAILABLE = 4,
 };
 
+std::string param_mnt_dir("/mnt/.lfs");
+std::string ramdisk_mnt_dir("/ramdisk");
+std::string system_mnt_dir("/system");
+
 // Utility for struct mntent
 class MountEntry {
   public:
@@ -90,7 +94,17 @@ class MountEntry {
 
     bool Umount(bool force) {
         LOG(INFO) << "Unmounting " << mnt_fsname_ << ":" << mnt_dir_ << " opts " << mnt_opts_;
-        int r = umount2(mnt_dir_.c_str(), force ? MNT_FORCE : 0);
+        int r;
+
+        if (mnt_dir_.compare(param_mnt_dir) == 0 ||
+            mnt_dir_.compare(ramdisk_mnt_dir) == 0 ||
+            mnt_dir_.compare(system_mnt_dir) == 0)
+        {
+            LOG(INFO) << "skipping umount of " << mnt_fsname_ << ":" << mnt_dir_ << " opts " << mnt_opts_;
+            return true;
+        }
+
+        r = umount2(mnt_dir_.c_str(), force ? MNT_FORCE : 0);
         if (r == 0) {
             LOG(INFO) << "Umounted " << mnt_fsname_ << ":" << mnt_dir_ << " opts " << mnt_opts_;
             return true;
-- 
2.11.0

