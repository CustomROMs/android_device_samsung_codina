From f676f66374d942cdc96150ebf24c06b4bc96a52b Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Sat, 22 Sep 2018 04:00:22 +0300
Subject: [PATCH 29/30] logd: disable auditd

Change-Id: If1490b50e207700fa42859d99d1b610fa4031634
---
 logd/main.cpp | 16 ++++++++--------
 1 file changed, 8 insertions(+), 8 deletions(-)

diff --git a/logd/main.cpp b/logd/main.cpp
index 4af0d21f1..581a4ceea 100644
--- a/logd/main.cpp
+++ b/logd/main.cpp
@@ -87,7 +87,7 @@
 //    logd
 //
 
-static int drop_privs(bool klogd, bool auditd) {
+static int drop_privs(bool klogd/*, bool auditd*/) {
     // Tricky, if ro.build.type is "eng" then this is true because of the
     // side effect that ro.debuggable == 1 as well, else it is false.
     bool eng =
@@ -125,8 +125,7 @@ static int drop_privs(bool klogd, bool auditd) {
                                                              cap_free);
     if (cap_clear(caps.get()) < 0) return -1;
     cap_value_t cap_value[] = { CAP_SETGID,  // must be first for below
-                                klogd ? CAP_SYSLOG : CAP_SETGID,
-                                auditd ? CAP_AUDIT_CONTROL : CAP_SETGID };
+                                klogd ? CAP_SYSLOG : CAP_SETGID };
     if (cap_set_flag(caps.get(), CAP_PERMITTED, arraysize(cap_value), cap_value,
                      CAP_SET) < 0) {
         return -1;
@@ -137,7 +136,7 @@ static int drop_privs(bool klogd, bool auditd) {
     }
     if (cap_set_proc(caps.get()) < 0) {
         android::prdebug(
-            "failed to set CAP_SETGID, CAP_SYSLOG or CAP_AUDIT_CONTROL (%d)",
+            "failed to set CAP_SETGID, CAP_SYSLOG (%d)",
             errno);
         if (!eng) return -1;
     }
@@ -471,9 +470,9 @@ int main(int argc, char* argv[]) {
         pthread_attr_destroy(&attr);
     }
 
-    bool auditd =
-        __android_logger_property_get_bool("ro.logd.auditd", BOOL_DEFAULT_TRUE);
-    if (drop_privs(klogd, auditd) != 0) {
+    //bool auditd =
+    //    __android_logger_property_get_bool("ro.logd.auditd", BOOL_DEFAULT_TRUE);
+    if (drop_privs(klogd/*, auditd*/) != 0) {
         return -1;
     }
 
@@ -528,6 +527,7 @@ int main(int argc, char* argv[]) {
     // and LogReader is notified to send updates to connected clients.
 
     LogAudit* al = nullptr;
+/*
     if (auditd) {
         al = new LogAudit(logBuf, reader,
                           __android_logger_property_get_bool(
@@ -535,7 +535,7 @@ int main(int argc, char* argv[]) {
                               ? fdDmesg
                               : -1);
     }
-
+*/
     LogKlog* kl = nullptr;
     if (klogd) {
         kl = new LogKlog(logBuf, reader, fdDmesg, fdPmesg, al != nullptr);
-- 
2.11.0

