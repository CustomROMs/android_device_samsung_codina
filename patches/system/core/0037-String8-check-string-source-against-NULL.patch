From cb605c855e47dfc8a9af4fcff034f6f2d4b64c80 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH 37/44] String8: check string source against NULL

On STE u8500 hardware, audiopolicy blobs are passing
NULL pointer to String8 class constructor on track start / resume.
Add a condition check to avoid segfault.
---
 libutils/String8.cpp | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/libutils/String8.cpp b/libutils/String8.cpp
index 580e870c7..456ab2328 100644
--- a/libutils/String8.cpp
+++ b/libutils/String8.cpp
@@ -23,6 +23,7 @@
 #include <utils/Log.h>
 #include <utils/String16.h>
 
+#include <cutils/compiler.h>
 #include <ctype.h>
 
 #include "SharedBuffer.h"
@@ -145,9 +146,14 @@ String8::String8(const String8& o)
 }
 
 String8::String8(const char* o)
-    : mString(allocFromUTF8(o, strlen(o)))
+    : mString(0)
 {
-    if (mString == NULL) {
+    if (CC_LIKELY(o != NULL)) {
+        mString = allocFromUTF8(o, strlen(o));
+        if (mString == NULL) {
+            mString = getEmptyString();
+        }
+    } else {
         mString = getEmptyString();
     }
 }
-- 
2.17.0

