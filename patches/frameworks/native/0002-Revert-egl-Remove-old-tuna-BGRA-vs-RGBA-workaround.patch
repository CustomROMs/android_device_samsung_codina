From 62df42813c09d53e3dba879996a9c4bb37ed33cb Mon Sep 17 00:00:00 2001
From: Ethan Chen <intervigil@gmail.com>
Date: Thu, 15 Oct 2015 13:50:10 -0700
Subject: [PATCH 2/4] Revert "egl: Remove old tuna BGRA vs RGBA workaround."

This reverts commit 733a80754786d39cdc0fee09509b194472c320bc.
and updated for Android O.

Change-Id: Ifb41720ed020489892a667914ea3bd3f1ac6504e
---
 opengl/libs/Android.bp     |  7 +++++++
 opengl/libs/EGL/eglApi.cpp | 11 +++++++++++
 2 files changed, 18 insertions(+)

diff --git a/opengl/libs/Android.bp b/opengl/libs/Android.bp
index d43c1648b..255c2218f 100644
--- a/opengl/libs/Android.bp
+++ b/opengl/libs/Android.bp
@@ -134,6 +134,13 @@ cc_library_static {
 
 cc_library_shared {
     name: "libEGL",
+    product_variables: {
+        lineage: {
+            egl_workaround_bug_10194508: {
+                cppflags: ["-DWORKAROUND_BUG_10194508"],
+            },
+        },
+    },
     defaults: ["egl_libs_defaults"],
     srcs: [
         "EGL/egl_tls.cpp",
diff --git a/opengl/libs/EGL/eglApi.cpp b/opengl/libs/EGL/eglApi.cpp
index c65bddfbb..87ea649fa 100644
--- a/opengl/libs/EGL/eglApi.cpp
+++ b/opengl/libs/EGL/eglApi.cpp
@@ -617,6 +617,16 @@ void getNativePixelFormat(EGLDisplay dpy, egl_connection_t* cnx, EGLConfig confi
     EGLint componentType = EGL_COLOR_COMPONENT_TYPE_FIXED_EXT;
     cnx->egl.eglGetConfigAttrib(dpy, config, EGL_COLOR_COMPONENT_TYPE_EXT, &componentType);
 
+#if WORKAROUND_BUG_10194508
+    int intFormat = (int)(*format);
+    if (!cnx->egl.eglGetConfigAttrib(dpy, config, EGL_NATIVE_VISUAL_ID,
+            &intFormat)) {
+        ALOGE("eglGetConfigAttrib(EGL_NATIVE_VISUAL_ID) failed: %#x",
+                eglGetError());
+        format = 0;
+    }
+    *format = (android_pixel_format)intFormat;
+#else
     EGLint a = 0;
     EGLint r, g, b;
     r = g = b = 0;
@@ -664,6 +674,7 @@ void getNativePixelFormat(EGLDisplay dpy, egl_connection_t* cnx, EGLConfig confi
             *format = HAL_PIXEL_FORMAT_RGBA_FP16;
         }
     }
+#endif
 }
 
 EGLBoolean sendSurfaceMetadata(egl_surface_t* s) {
-- 
2.11.0

