From bc15551d39a449ccd8eabf51feaa90166648ffa7 Mon Sep 17 00:00:00 2001
From: Wan Zhou <wanz@nvidia.com>
Date: Sat, 4 Feb 2017 14:59:47 +0800
Subject: [PATCH 41/46] Fix leak of file descriptors and memory.

 1. fds must be explicitly closed if it is not retained by Flattenable::unflatten().
 2. must delete allocated handle before setting to NULL.
---
 libs/binder/include/binder/Parcel.h | 8 +++++++-
 libs/ui/GraphicBuffer.cpp           | 1 +
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/libs/binder/include/binder/Parcel.h b/libs/binder/include/binder/Parcel.h
index dc08b99c2c..113c8bf6ad 100644
--- a/libs/binder/include/binder/Parcel.h
+++ b/libs/binder/include/binder/Parcel.h
@@ -560,7 +560,13 @@ private:
         }
         virtual status_t unflatten(void const* buffer, size_t size, int const* fds, size_t count) {
 #ifdef STE_HARDWARE
-            return const_cast<Flattenable&>(val).unflatten(buffer, size, fds, count);
+            status_t err = const_cast<Flattenable&>(val).unflatten(buffer, size, fds, count);
+            if (err != NO_ERROR) {
+                for (size_t i = 0; i < count; i++) {
+                    close(fds[i]);
+                }
+            }
+            return err;
 #else
             return const_cast<Flattenable<T>&>(val).unflatten(buffer, size, fds, count);
 #endif
diff --git a/libs/ui/GraphicBuffer.cpp b/libs/ui/GraphicBuffer.cpp
index 654088d394..1329c4be43 100644
--- a/libs/ui/GraphicBuffer.cpp
+++ b/libs/ui/GraphicBuffer.cpp
@@ -478,6 +478,7 @@ status_t GraphicBuffer::unflatten(
         status_t err = mBufferMapper.importBuffer(handle);
         if (err != NO_ERROR) {
             width = height = stride = format = layerCount = usage = 0;
+            native_handle_delete(const_cast<native_handle*>(handle));
             handle = NULL;
             ALOGE("unflatten: registerBuffer failed: %s (%d)",
                     strerror(-err), err);
-- 
2.17.0

