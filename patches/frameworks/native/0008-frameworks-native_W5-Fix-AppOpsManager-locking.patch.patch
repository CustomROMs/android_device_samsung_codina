From 264b2c0876b327f55e117d2f99c8c54d46bb7111 Mon Sep 17 00:00:00 2001
From: Shilin Victor <radicaldreamer00001@gmail.com>
Date: Fri, 29 Mar 2019 22:51:45 +0300
Subject: [PATCH 08/30] frameworks-native_W5-Fix-AppOpsManager-locking.patch

Change-Id: I21baf8230f11a506fbca5cf550e87e6a6402b18b
---
 libs/binder/AppOpsManager.cpp | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/libs/binder/AppOpsManager.cpp b/libs/binder/AppOpsManager.cpp
index f8626cb85..3017c6190 100644
--- a/libs/binder/AppOpsManager.cpp
+++ b/libs/binder/AppOpsManager.cpp
@@ -14,6 +14,7 @@
  * limitations under the License.
  */
 
+#include <mutex>
 #include <binder/AppOpsManager.h>
 #include <binder/Binder.h>
 #include <binder/IServiceManager.h>
@@ -41,8 +42,8 @@ AppOpsManager::AppOpsManager()
 
 sp<IAppOpsService> AppOpsManager::getService()
 {
+    std::lock_guard<Mutex> scoped_lock(mLock);
     int64_t startTime = 0;
-    mLock.lock();
     sp<IAppOpsService> service = mService;
     while (service == NULL || !IInterface::asBinder(service)->isBinderAlive()) {
         sp<IBinder> binder = defaultServiceManager()->checkService(_appops);
@@ -62,7 +63,6 @@ sp<IAppOpsService> AppOpsManager::getService()
             mService = service;
         }
     }
-    mLock.unlock();
     return service;
 }
 
-- 
2.11.0

