From 706a1c196cbf521ad5e8c98cc0dc21249684bd19 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH 36/45] surfaceflinger: make critical threads SCHED_FIFO

Sets the main thread, EventThread, and SFEventThread to SCHED_FIFO to minimize jitter.
---
 services/sensorservice/Android.bp             | 1 +
 services/sensorservice/SensorService.cpp      | 2 ++
 services/sensorservice/hidl/Android.bp        | 1 +
 services/sensorservice/hidl/SensorManager.cpp | 2 ++
 4 files changed, 6 insertions(+)

diff --git a/services/sensorservice/Android.bp b/services/sensorservice/Android.bp
index a7f3a5235e..46eed47d49 100644
--- a/services/sensorservice/Android.bp
+++ b/services/sensorservice/Android.bp
@@ -30,6 +30,7 @@ cc_library_shared {
         "-Wall",
         "-Werror",
         "-Wextra",
+        "-DHARDWARE_FIFO_SENSOR_SERVICE",
         "-fvisibility=hidden"
     ],
 
diff --git a/services/sensorservice/SensorService.cpp b/services/sensorservice/SensorService.cpp
index dc491d97c0..9a3da26999 100644
--- a/services/sensorservice/SensorService.cpp
+++ b/services/sensorservice/SensorService.cpp
@@ -272,8 +272,10 @@ void SensorService::onFirstRef() {
             mAckReceiver->run("SensorEventAckReceiver", PRIORITY_URGENT_DISPLAY);
             run("SensorService", PRIORITY_URGENT_DISPLAY);
 
+#ifndef HARDWARE_FIFO_SENSOR_SERVICE
             // priority can only be changed after run
             enableSchedFifoMode();
+#endif
         }
     }
 }
diff --git a/services/sensorservice/hidl/Android.bp b/services/sensorservice/hidl/Android.bp
index 02c13fa579..e480566d5a 100644
--- a/services/sensorservice/hidl/Android.bp
+++ b/services/sensorservice/hidl/Android.bp
@@ -9,6 +9,7 @@ cc_library_shared {
     cflags: [
         "-Wall",
         "-Werror",
+        "-DHARDWARE_FIFO_SENSOR_SERVICE",
     ],
     shared_libs: [
         "libbase",
diff --git a/services/sensorservice/hidl/SensorManager.cpp b/services/sensorservice/hidl/SensorManager.cpp
index fee6da1e60..ed30b79a19 100644
--- a/services/sensorservice/hidl/SensorManager.cpp
+++ b/services/sensorservice/hidl/SensorManager.cpp
@@ -142,12 +142,14 @@ sp<Looper> SensorManager::getLooper() {
         mStopThread = false;
         std::thread pollThread{[&stopThread = mStopThread, looper = mLooper, javaVm = mJavaVm] {
 
+#ifndef HARDWARE_FIFO_SENSOR_SERVICE
             struct sched_param p = {0};
             p.sched_priority = 10;
             if (sched_setscheduler(0 /* current thread*/, SCHED_FIFO, &p) != 0) {
                 LOG(WARNING) << "Could not use SCHED_FIFO for looper thread: "
                         << strerror(errno);
             }
+#endif
 
             // set looper
             Looper::setForThread(looper);
-- 
2.17.0

