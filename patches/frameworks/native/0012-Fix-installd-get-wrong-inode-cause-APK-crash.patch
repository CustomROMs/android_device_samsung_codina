From b71d4907cd3c57294b7aa8e424c137e4b8f7917b Mon Sep 17 00:00:00 2001
From: Rock Yeh <rock.yeh@mediatek.com>
Date: Thu, 13 Jul 2017 21:15:58 +0800
Subject: [PATCH 12/49] Fix installd get wrong inode cause APK crash

---
 cmds/installd/utils.cpp | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/cmds/installd/utils.cpp b/cmds/installd/utils.cpp
index 1ff45e484..47523a477 100644
--- a/cmds/installd/utils.cpp
+++ b/cmds/installd/utils.cpp
@@ -526,6 +526,10 @@ int delete_dir_contents(const char *pathname,
             res = -1;
         }
     }
+    std::string path(pathname);
+    write_path_inode(path, "cache", kXattrInodeCache);
+    write_path_inode(path, "code_cache", kXattrInodeCodeCache);
+
     return res;
 }
 
@@ -681,6 +685,15 @@ int write_path_inode(const std::string& parent, const char* name, const char* in
     auto path = StringPrintf("%s/%s", parent.c_str(), name);
 
     if (get_path_inode(path, &inode) != 0) {
+        if (getxattr(parent.c_str(), inode_xattr, &inode_raw,
+                     sizeof(inode_raw)) == sizeof(inode_raw)) {
+            // Reset path inode to 0, prevent PMS get an wrong inode.
+            inode_raw = 0;
+            if (setxattr(parent.c_str(), inode_xattr, &inode_raw, sizeof(inode_raw), 0) != 0 &&
+                errno != EOPNOTSUPP) {
+                PLOG(ERROR) << "Failed to reset xattr " << inode_xattr << " at " << parent;
+            }
+        }
         // Path probably doesn't exist yet; ignore
         return 0;
     }
@@ -697,7 +710,8 @@ int write_path_inode(const std::string& parent, const char* name, const char* in
     }
 
     inode_raw = inode;
-    if (setxattr(parent.c_str(), inode_xattr, &inode_raw, sizeof(inode_raw), 0) != 0 && errno != EOPNOTSUPP) {
+    if (setxattr(parent.c_str(), inode_xattr, &inode_raw, sizeof(inode_raw), 0) != 0 &&
+        errno != EOPNOTSUPP) {
         PLOG(ERROR) << "Failed to write xattr " << inode_xattr << " at " << parent;
         return -1;
     } else {
-- 
2.11.0

