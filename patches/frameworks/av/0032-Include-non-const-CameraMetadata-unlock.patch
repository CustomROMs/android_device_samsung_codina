From f231a6c2116daa9de318a7071fb02dca091d9d48 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH 32/70] Include non-const CameraMetadata unlock.

Needed for some legacy camera hals.
---
 camera/CameraMetadata.cpp              | 14 ++++++++++++++
 camera/include/camera/CameraMetadata.h |  1 +
 2 files changed, 15 insertions(+)

diff --git a/camera/CameraMetadata.cpp b/camera/CameraMetadata.cpp
index e143e052b..35bf77e36 100644
--- a/camera/CameraMetadata.cpp
+++ b/camera/CameraMetadata.cpp
@@ -80,6 +80,20 @@ const camera_metadata_t* CameraMetadata::getAndLock() const {
     return mBuffer;
 }
 
+status_t CameraMetadata::unlock(const camera_metadata_t *buffer) {
+    if (!mLocked) {
+        ALOGE("%s: Can't unlock a non-locked CameraMetadata!", __FUNCTION__);
+        return INVALID_OPERATION;
+    }
+    if (buffer != mBuffer) {
+        ALOGE("%s: Can't unlock CameraMetadata with wrong pointer!",
+                __FUNCTION__);
+        return BAD_VALUE;
+    }
+    mLocked = false;
+    return OK;
+}
+
 status_t CameraMetadata::unlock(const camera_metadata_t *buffer) const {
     if (!mLocked) {
         ALOGE("%s: Can't unlock a non-locked CameraMetadata!", __FUNCTION__);
diff --git a/camera/include/camera/CameraMetadata.h b/camera/include/camera/CameraMetadata.h
index e2b743db5..057ac5f1e 100644
--- a/camera/include/camera/CameraMetadata.h
+++ b/camera/include/camera/CameraMetadata.h
@@ -68,6 +68,7 @@ class CameraMetadata: public Parcelable {
      * being unlocked.
      */
     status_t unlock(const camera_metadata_t *buffer) const;
+    status_t unlock(const camera_metadata_t *buffer);
 
     /**
      * Release a raw metadata buffer to the caller. After this call,
-- 
2.11.0

