From 479a2469491eb9e2b3c58b5ba13da1c69fd27531 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH 56/67] ClientManager: Avoid evicting negative priority clients

 * When launching Camera2, the ClientService stack could
    launch as a back camera client (ID 0) and have a second
    instance retrieving front camera characteristics (ID 1),
    thus triggering an eviction of the Camera2 client

 * Example stack logs :

    CameraService: CameraService::connect call (PID -1
      "com.android.camera2", camera ID 0) for HAL version
      default and Camera API version 1
---
 services/camera/libcameraservice/utils/ClientManager.h | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/services/camera/libcameraservice/utils/ClientManager.h b/services/camera/libcameraservice/utils/ClientManager.h
index d7135f1bd..71450d348 100644
--- a/services/camera/libcameraservice/utils/ClientManager.h
+++ b/services/camera/libcameraservice/utils/ClientManager.h
@@ -461,7 +461,7 @@ ClientManager<KEY, VALUE, LISTENER>::wouldEvictLocked(
                 evictList.push_back(client);
                 return evictList;
             } else if (conflicting || ((totalCost > mMaxCost && curCost > 0) &&
-                    (curPriority >= priority) &&
+                    (curPriority >= priority && priority.getScore() >= 0) &&
                     !(highestPriorityOwner == owner && owner == curOwner))) {
                 // Add a pre-existing client to the eviction list if:
                 // - We are adding a client with higher priority that conflicts with this one.
-- 
2.11.0

