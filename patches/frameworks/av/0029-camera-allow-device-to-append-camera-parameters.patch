From 130d2a05efd435839ec25100ba30cb05d03cf7c5 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Mon, 20 Aug 2018 22:57:43 +0300
Subject: [PATCH 29/70] camera: allow device to append camera parameters

Overload using include/camera/CameraParametersExtra.h in device
tree to add device specific camera parameters.
---
 camera/CameraParameters.cpp                        |  5 ++
 camera/include/camera/CameraParameters.h           |  5 ++
 camera/include/camera/CameraParametersExtra.h      | 48 +++++++++++++++++
 .../camera/CameraParametersExtraDurationTimer.h    | 62 ++++++++++++++++++++++
 4 files changed, 120 insertions(+)
 create mode 100644 camera/include/camera/CameraParametersExtra.h
 create mode 100644 camera/include/camera/CameraParametersExtraDurationTimer.h

diff --git a/camera/CameraParameters.cpp b/camera/CameraParameters.cpp
index de8ac2ffc..11f2fd176 100644
--- a/camera/CameraParameters.cpp
+++ b/camera/CameraParameters.cpp
@@ -21,6 +21,7 @@
 #include <string.h>
 #include <stdlib.h>
 #include <camera/CameraParameters.h>
+#include <camera/CameraParametersExtra.h>
 #include <system/graphics.h>
 
 namespace android {
@@ -173,6 +174,10 @@ const char CameraParameters::FOCUS_MODE_CONTINUOUS_PICTURE[] = "continuous-pictu
 const char CameraParameters::LIGHTFX_LOWLIGHT[] = "low-light";
 const char CameraParameters::LIGHTFX_HDR[] = "high-dynamic-range";
 
+#ifdef CAMERA_PARAMETERS_EXTRA_C
+CAMERA_PARAMETERS_EXTRA_C
+#endif
+
 CameraParameters::CameraParameters()
                 : mMap()
 {
diff --git a/camera/include/camera/CameraParameters.h b/camera/include/camera/CameraParameters.h
index ba33ffe63..74517b47b 100644
--- a/camera/include/camera/CameraParameters.h
+++ b/camera/include/camera/CameraParameters.h
@@ -19,6 +19,7 @@
 
 #include <utils/KeyedVector.h>
 #include <utils/String8.h>
+#include <camera/CameraParametersExtra.h>
 
 namespace android {
 
@@ -683,6 +684,10 @@ public:
     // High-dynamic range mode
     static const char LIGHTFX_HDR[];
 
+#ifdef CAMERA_PARAMETERS_EXTRA_H
+CAMERA_PARAMETERS_EXTRA_H
+#endif
+
     /**
      * Returns the the supported preview formats as an enum given in graphics.h
      * corrsponding to the format given in the input string or -1 if no such
diff --git a/camera/include/camera/CameraParametersExtra.h b/camera/include/camera/CameraParametersExtra.h
new file mode 100644
index 000000000..1121e19c1
--- /dev/null
+++ b/camera/include/camera/CameraParametersExtra.h
@@ -0,0 +1,48 @@
+/*
+ * Copyright (C) 2014 The CyanogenMod Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+#include "camera/CameraParametersExtraDurationTimer.h"
+
+#define CAMERA_PARAMETERS_EXTRA_C \
+const char CameraParameters::SCENE_MODE_AQUA[] = "aqua"; \
+const char CameraParameters::SCENE_MODE_BACKLIGHT[] = "backlight"; \
+const char CameraParameters::SCENE_MODE_DUSKDAWN[] = "duskdawn"; \
+const char CameraParameters::SCENE_MODE_FALLCOLOR[] = "fallcolor"; \
+const char CameraParameters::SCENE_MODE_TEXT[] = "text"; \
+const char CameraParameters::PIXEL_FORMAT_YUV420SPNV12[] = "yuv420spnv12"; \
+const char CameraParameters::PIXEL_FORMAT_YUV420MB[] = "yuv420mb"; \
+const char CameraParameters::PIXEL_FORMAT_YVU422SP[] = "yvu422sp"; \
+const char CameraParameters::PIXEL_FORMAT_YVU422P[] = "yvu422p"; \
+const char CameraParameters::PIXEL_FORMAT_YVU420SP[] = "yvu420sp"; \
+const char CameraParameters::PIXEL_FORMAT_YVU420P[]  = "yvu420p"; \
+const char CameraParameters::KEY_RECORD_STRIDE[] = "record-stride"; \
+const char CameraParameters::KEY_RECORD_SLICE_HEIGHT[] = "record-slice-height"; \
+CAMERA_PARAMETERS_EXTRA_C_DURATION_TIMER \
+
+#define CAMERA_PARAMETERS_EXTRA_H \
+    static const char SCENE_MODE_AQUA[]; \
+    static const char SCENE_MODE_BACKLIGHT[]; \
+    static const char SCENE_MODE_DUSKDAWN[]; \
+    static const char SCENE_MODE_FALLCOLOR[]; \
+    static const char SCENE_MODE_TEXT[]; \
+    static const char PIXEL_FORMAT_YUV420SPNV12[]; \
+    static const char PIXEL_FORMAT_YVU422SP[]; \
+    static const char PIXEL_FORMAT_YVU422P[];  \
+    static const char PIXEL_FORMAT_YVU420SP[]; \
+    static const char PIXEL_FORMAT_YVU420P[]; \
+    static const char PIXEL_FORMAT_YUV420MB[]; \
+    static const char KEY_RECORD_STRIDE[]; \
+    static const char KEY_RECORD_SLICE_HEIGHT[];
diff --git a/camera/include/camera/CameraParametersExtraDurationTimer.h b/camera/include/camera/CameraParametersExtraDurationTimer.h
new file mode 100644
index 000000000..9f2f049c1
--- /dev/null
+++ b/camera/include/camera/CameraParametersExtraDurationTimer.h
@@ -0,0 +1,62 @@
+#define CAMERA_PARAMETERS_EXTRA_C_DURATION_TIMER \
+\
+class DurationTimer { \
+public: \
+    DurationTimer() {} \
+    ~DurationTimer() {} \
+    void start(); \
+    void stop(); \
+    long long durationUsecs() const; \
+    static long long subtractTimevals(const struct timeval* ptv1, \
+        const struct timeval* ptv2); \
+    static void addToTimeval(struct timeval* ptv, long usec); \
+private: \
+    struct timeval  mStartWhen; \
+    struct timeval  mStopWhen; \
+}; \
+\
+void DurationTimer::start(void) \
+{ \
+    gettimeofday(&mStartWhen, NULL); \
+} \
+\
+void DurationTimer::stop(void) \
+{ \
+    gettimeofday(&mStopWhen, NULL); \
+} \
+\
+long long DurationTimer::durationUsecs(void) const \
+{ \
+    return (long) subtractTimevals(&mStopWhen, &mStartWhen); \
+} \
+\
+/*static*/ long long DurationTimer::subtractTimevals(const struct timeval* ptv1, \
+    const struct timeval* ptv2) \
+{ \
+    long long stop  = ((long long) ptv1->tv_sec) * 1000000LL + \
+                      ((long long) ptv1->tv_usec); \
+    long long start = ((long long) ptv2->tv_sec) * 1000000LL + \
+                      ((long long) ptv2->tv_usec); \
+    return stop - start; \
+} \
+\
+/*static*/ void DurationTimer::addToTimeval(struct timeval* ptv, long usec) \
+{ \
+    if (usec < 0) { \
+        ALOG(LOG_WARN, "", "Negative values not supported in addToTimeval\n"); \
+        return; \
+    } \
+\
+    if (ptv->tv_usec >= 1000000) { \
+        ptv->tv_sec += ptv->tv_usec / 1000000; \
+        ptv->tv_usec %= 1000000; \
+    } \
+\
+    ptv->tv_usec += usec % 1000000; \
+    if (ptv->tv_usec >= 1000000) { \
+        ptv->tv_usec -= 1000000; \
+        ptv->tv_sec++; \
+    } \
+    ptv->tv_sec += usec / 1000000; \
+} \
+/* END OF DEF */
-- 
2.11.0

