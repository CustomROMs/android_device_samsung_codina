From fc12e6e4f0951828c5b59d24511f7905ca62c6e2 Mon Sep 17 00:00:00 2001
From: Shilin Victor <radicaldreamer00001@gmail.com>
Date: Fri, 29 Mar 2019 22:51:40 +0300
Subject: [PATCH 45/45] frameworks-av_WW036-Limit-memory-size-low-RAM.patch

Change-Id: I762d75cf00a62ec3ba0cc3cc6e27cdfa2b8d37e4
---
 media/libmedia/MediaUtils.cpp | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/media/libmedia/MediaUtils.cpp b/media/libmedia/MediaUtils.cpp
index a02ca65a7..6d6c10250 100644
--- a/media/libmedia/MediaUtils.cpp
+++ b/media/libmedia/MediaUtils.cpp
@@ -23,6 +23,10 @@
 #include <unistd.h>
 
 #include "MediaUtils.h"
+#include <string.h>
+#ifndef UINT32_256M
+#define UINT32_256M (262144000U)
+#endif
 
 namespace android {
 
@@ -53,6 +57,15 @@ void limitProcessMemory(
         ALOGW("couldn't determine total RAM");
     }
 
+    if (maxMem < UINT32_256M && !strcmp(property, "ro.media.maxmem")) {
+        /* Add by mtk: Consideration of gmo 512M project low mem:
+         * set limit 256M for media.extractor process when necessary
+         * Note: 256M maybe have risk for gmo 512M, it can adjust 256M to smaller
+         * if media.extractor process allow
+         */
+        maxMem = UINT32_256M;
+        ALOGV("maxMem: %zu too small, set to fixed 256M Bytes", maxMem);
+    }
     int64_t propVal = property_get_int64(property, maxMem);
     if (propVal > 0 && uint64_t(propVal) <= SIZE_MAX) {
         maxMem = propVal;
-- 
2.11.0

