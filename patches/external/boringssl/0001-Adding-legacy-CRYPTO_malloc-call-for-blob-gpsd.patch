From 71e1ab78c5755b912ca509e0ebddcd67cd622c2d Mon Sep 17 00:00:00 2001
From: Schischu <schischu65@gmail.com>
Date: Sun, 18 Oct 2015 15:33:55 +0200
Subject: [PATCH] Adding legacy CRYPTO_malloc call for blob gpsd

Change-Id: I6267e0743747593e8d2a3a0e5879ced3d109b081
---
 src/crypto/mem.c          | 5 +++++
 src/include/openssl/mem.h | 5 ++++-
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/src/crypto/mem.c b/src/crypto/mem.c
index 67f74b7..ca3da75 100644
--- a/src/crypto/mem.c
+++ b/src/crypto/mem.c
@@ -137,6 +137,11 @@ void OPENSSL_cleanse(void *ptr, size_t len) {
 #endif  // !OPENSSL_NO_ASM
 }
 
+/* Needed by gpsd */
+void *CRYPTO_malloc(int num, const char *file, int line) {
+  return OPENSSL_malloc(num);
+}
+
 int CRYPTO_memcmp(const void *in_a, const void *in_b, size_t len) {
   const uint8_t *a = in_a;
   const uint8_t *b = in_b;
diff --git a/src/include/openssl/mem.h b/src/include/openssl/mem.h
index 7d7087e..79e9689 100644
--- a/src/include/openssl/mem.h
+++ b/src/include/openssl/mem.h
@@ -82,6 +82,9 @@ OPENSSL_EXPORT void *OPENSSL_malloc(size_t size);
 // memory allocated at |ptr| and frees it.
 OPENSSL_EXPORT void OPENSSL_free(void *ptr);
 
+/* Needed by gpsd */
+OPENSSL_EXPORT void *CRYPTO_malloc(int num, const char *file, int line);
+
 // OPENSSL_realloc returns a pointer to a buffer of |new_size| bytes that
 // contains the contents of |ptr|. Unlike |realloc|, a new buffer is always
 // allocated and the data at |ptr| is always wiped and freed.
@@ -132,7 +135,7 @@ OPENSSL_EXPORT int BIO_vsnprintf(char *buf, size_t n, const char *format,
 
 // Deprecated functions.
 
-#define CRYPTO_malloc OPENSSL_malloc
+//#define CRYPTO_malloc OPENSSL_malloc
 #define CRYPTO_realloc OPENSSL_realloc
 #define CRYPTO_free OPENSSL_free
 
-- 
2.11.0

